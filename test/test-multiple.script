;;; -*- Lisp -*-
(load "script-support.lisp")
(load-asdf)

(quit-on-error
 (let* ((asd (asdf:merge-pathnames* (asdf:coerce-pathname "test-multiple.asd")
                                    *test-directory*))
        (tmp (asdf:merge-pathnames* (asdf:coerce-pathname "../tmp/")
                                    *test-directory*))
        (asd2 (asdf:merge-pathnames* (asdf:coerce-pathname "test-multiple-too.asd")
                                     tmp))
        (file4 (asdf:compile-file-pathname* "file4")))
   (setf asdf:*central-registry* `(*default-pathname-defaults* ,tmp))
   (assert (= 0 (asdf:run-shell-command
                 (format nil "/bin/ln -sf ~A ~A"
                         (native-namestring asd)
                         (native-namestring asd2)))))
   (asdf:oos 'asdf:load-source-op 'test-multiple-too)
   (assert (symbol-value (find-symbol (string :*file3*) :test-package)))
   (asdf:load-system 'test-multiple-free)
   (assert (asdf::probe-file* file4))))
