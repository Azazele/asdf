;;; -*- Lisp -*-

(load-asdf)

(touch-file "test1.asd" :offset -3600) ;; touch test1.asd an hour ago.
(touch-file "file1.lisp" :offset -3500)
(touch-file "file2.lisp" :offset -3400)

(DBG "loading test1")
(asdf:load-system 'test1)

(defparameter *file1* (test-fasl "file1"))
(defparameter *file2* (test-fasl "file2"))
(defparameter *date* (file-write-date "test1.asd"))
(defparameter *then* (file-write-date *file2*))

(assert-equal *file1* (first (output-files 'compile-op '("test1" "file1"))))

(DBG "test that it compiled" *date* *then*)
(assert (probe-file *file1*))
(assert (probe-file *file2*))

(DBG "and loaded")
(assert (symbol-value (find-symbol (symbol-name :*file1*) :test-package)))

(DBG "now remove file2 that depends-on file1" *date*)
(touch-file *file1* :timestamp (+ *date* 500))
(assert-equal (+ *date* 500) (file-write-date *file1*))
(asdf::delete-file-if-exists *file2*)

(DBG "load again")
(asdf:clear-system 'test1)
(asdf:load-system 'test1)
(DBG "check that file1 is _not_ recompiled, but file2 is" (file-write-date *file1*))
(assert-equal (+ *date* 500) (file-write-date *file1*))
(assert-compare (<= *then* (file-write-date *file2*)))

(DBG "now touch file1 and check that file2 _is_ also recompiled")
;; XXX run-shell-command loses if *default-pathname-defaults* is not the
;; unix cwd.  this is not a problem for run-tests.sh, but can be in general
(defparameter *before* (file-write-date *file2*))
(touch-file "file1.lisp" :timestamp (+ *date* 3000)) ;; touch file1 a minute ago.
(touch-file *file2* :timestamp (+ *date* 2000)) ;; touch file2.fasl some time before.
(asdf:clear-system 'test1)
(asdf:operate 'asdf:load-op 'test1)
(DBG :foo (file-write-date *file2*) *before*)
(assert-compare (>= (file-write-date *file2*) *before*))
