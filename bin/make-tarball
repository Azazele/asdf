":" ; exec sbcl --script "$0" "$@" ; exit # -*- Lisp -*-
;;;;; Really runs on any decent Common Lisp implementation

(load (make-pathname :name "prelude" :type "lisp" :defaults *load-pathname*)
  :verbose nil :print nil)

;;;;; create tarball for the current version.

(in-package :asdf)

(asdf-debug)

(describe (find-system :asdf))

(defparameter *ad* (find-system :asdf-driver))
(defparameter *asdf-directory* (system-source-directory *ad*))
(defparameter *version*
  (safe-read-first-file-form (subpathname *asdf-directory* "version.lisp-expr")))

(DBG :foo *ad* *version* (asdf-version))

(defparameter *files*
  (append
   (loop :for c :in (operated-components *ad*
                                         :goal-operation 'load-op
                                         :keep-operation 'load-op)
         :for n = (enough-namestring (component-pathname c) *asdf-directory*)
         :when (typep c 'cl-source-file)
           :collect n)
   (list "version.lisp-expr" "asdf-driver.asd")))

;; make asdf:
;;;(run-program/ (list "make" "-C" (native-namestring *asdf-directory*) "build/asdf.lisp"))

#|
if [ -d "tmp" ]; then
    rm -r tmp
fi
mkdir tmp

archive_file="tmp/asdf-$tag.tar.gz"
echo "Create tmp/asdf.tar.gz with tag $tag"
git archive $tag --prefix="asdf/" --format=tar | \
    gzip > $archive_file
|#