#!/bin/sh
# Takes one optional argument: the new version number.
# If not provided, increment previous patch number,
# e.g. 3.45.6 ==> 3.45.7, or 3.56 ==> 3.56.1
NEWVER="${1}"
PROG="$0"
ASDFDIR="$(cd $(dirname $PROG)/.. ; /bin/pwd)" ## readlink -f doesn't work on BSD

if [ -z "$NEWVER" ] ; then
  OLDVER="$(grep '         (asdf-version "' ${ASDFDIR}/header.lisp | cut -d\" -f2)"
  NEWVER="$(echo $OLDVER | perl -npe 's/([0-9].[0-9]+)(\.([0-9]+))?/"${1}.".($3+1)/e')"
fi
echo "Setting ASDF version to $NEWVER"
for i in ${ASDFDIR}/header.lisp ${ASDFDIR}/upgrade.lisp ; do
  perl -i.bak -npe 's/^(         \(asdf-version "|;;; This is ASDF )[0-9.]+("\)|:)/${1}'"$NEWVER"'${2}/' $i
done
for i in ${ASDFDIR}/asdf.asd ; do # ${ASDFDIR}/generate-asdf.asd
  perl -i.bak -npe 's/^(  :version ")[0-9.]+(")/${1}'"$NEWVER"'${2}/' $i
done

cat<<EOF
To complete the version change, you may:
	git commit -a
	git tag $NEWVER
EOF
